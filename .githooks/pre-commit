#!/bin/sh
# Auto-format and analyze Dart files before commit

set -e

# Get list of staged Dart files
DART_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.dart$' || true)

if [ -n "$DART_FILES" ]; then
  echo "ğŸ”§ Running dart fix --apply..."
  melos exec -- "dart fix --apply" 2>/dev/null || true

  echo "ğŸ“ Formatting Dart files..."
  dart format .

  # Re-add formatted/fixed files to staging
  echo "$DART_FILES" | xargs git add

  echo "âœ… Files formatted and fixed."
fi

echo "ğŸ” Running analyzer..."
if ! melos run analyze; then
  echo ""
  echo "âŒ Analyzer found errors. Fix them before committing."
  exit 1
fi

echo "âœ… All checks passed!"
exit 0
